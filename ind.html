<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indrasha</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.2.0/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-error { background: #dc3545; }

        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav button:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .metric-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #3498db;
            text-align: center;
            margin: 10px 0;
        }

        .metric-unit {
            font-size: 0.9em;
            color: #7f8c8d;
            text-align: center;
        }

        .prediction-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .controls-section {
            margin-top: 30px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .api-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .ml-insights {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .ml-insights h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .insight-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .insight-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .data-refresh {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .data-refresh:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        .data-refresh.rotating {
            animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* AI Assistant Styles */
        .ai-assistant {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        .ai-button {
            background: linear-gradient(135deg, #024726 0%, #4ba283 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-button:hover {
            transform: scale(1.1);
        }

        .ai-chat-container {
            position: absolute;
            bottom: 80px;
            left: 0;
            width: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            max-height: 500px;
        }

        .ai-chat-container.open {
            display: flex;
        }

        .ai-chat-header {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .ai-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .ai-message.user {
            background: #e3f2fd;
            margin-left: auto;
            border-radius: 10px 10px 0 10px;
        }

        .ai-message.assistant {
            background: white;
            margin-right: auto;
            border-radius: 10px 10px 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ai-chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
            background: white;
            border-radius: 0 0 15px 15px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .ai-chat-input button {
            margin-left: 10px;
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .ai-chat-input button:hover {
            background: #5a67d8;
        }

        .ai-typing {
            display: flex;
            align-items: center;
            padding: 5px 15px;
            color: #666;
            font-size: 0.9em;
        }

        .ai-typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .ai-typing-dot:nth-child(1) { animation-delay: 0s; }
        .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .ai-suggestion {
            margin: 5px 0;
            padding: 8px 12px;
            background: #f0f4f8;
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-suggestion:hover {
            background: #e0e7f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌍 Indrasha The Environment Before Life </h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator status-active"></div>
                    <span>API Connected</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-active"></div>
                    <span>AI/ML Models Active</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-warning"></div>
                    <span>3 Active Alerts</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-active"></div>
                    <span>Last Update: <span id="last-update">Just now</span></span>
                </div>
            </div>
        </div>

        <nav class="nav">
            <button class="active" onclick="switchTab('dashboard')">Dashboard</button>
            <button onclick="switchTab('air-quality')">Air Quality</button>
            <button onclick="switchTab('water-quality')">Water Quality</button>
            <button onclick="switchTab('predictions')">AI Predictions</button>
            <button onclick="switchTab('controls')">Controls</button>
            <button onclick="switchTab('reports')">Reports</button>
        </nav>

        <div id="dashboard" class="tab-content active">
            <div class="api-status">
                <div class="api-indicator"></div>
                <span>Real-time data streaming from environmental sensors</span>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Air Quality Index</div>
                        <div class="prediction-badge">AI Predicted</div>
                    </div>
                    <div class="metric-value" id="aqi-value">72</div>
                    <div class="metric-unit">AQI (Moderate)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Water Quality Index</div>
                        <div class="prediction-badge">Live Data</div>
                    </div>
                    <div class="metric-value" id="wqi-value">94</div>
                    <div class="metric-unit">WQI (Excellent)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">PM2.5 Concentration</div>
                        <div class="prediction-badge">Trending</div>
                    </div>
                    <div class="metric-value" id="pm25-value">35</div>
                    <div class="metric-unit">μg/m³</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Temperature</div>
                        <div class="prediction-badge">Live</div>
                    </div>
                    <div class="metric-value" id="temp-value">24.5</div>
                    <div class="metric-unit">°C</div>
                </div>
            </div>

            <div class="alert alert-warning">
                <strong>⚠️ AI Alert:</strong> PM2.5 levels predicted to increase by 15% in the next 2 hours due to traffic pattern analysis.
            </div>

            <div class="ml-insights">
                <h3>🤖 AI/ML Insights</h3>
                <div class="insight-item">
                    <div class="insight-icon">📊</div>
                    <div>Machine learning model predicts air quality will improve by 20% tomorrow based on weather patterns</div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon">🔍</div>
                    <div>Anomaly detection: Water pH levels show unusual pattern - investigating potential cause</div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon">📈</div>
                    <div>Trend analysis: NO₂ levels correlate strongly with traffic data (R² = 0.87)</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="realtime-chart"></canvas>
            </div>
        </div>

        <div id="air-quality" class="tab-content">
            <h2>Air Quality Monitoring</h2>
            <div class="api-status">
                <div class="api-indicator"></div>
                <span>Connected to EPA Air Quality API & Local Sensors</span>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">PM2.5</div>
                    <div class="metric-value" id="air-pm25">35</div>
                    <div class="metric-unit">μg/m³</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Ozone (O₃)</div>
                    <div class="metric-value" id="air-o3">0.045</div>
                    <div class="metric-unit">ppm</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">NO₂</div>
                    <div class="metric-value" id="air-no2">0.030</div>
                    <div class="metric-unit">ppm</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="air-trend-chart"></canvas>
            </div>
        </div>

        <div id="water-quality" class="tab-content">
            <h2>Water Quality Monitoring</h2>
            <div class="api-status">
                <div class="api-indicator"></div>
                <span>Connected to Water Quality Sensors & USGS API</span>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">pH Level</div>
                    <div class="metric-value" id="water-ph">7.2</div>
                    <div class="metric-unit">pH</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Dissolved Oxygen</div>
                    <div class="metric-value" id="water-do">8.5</div>
                    <div class="metric-unit">mg/L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Turbidity</div>
                    <div class="metric-value" id="water-turbidity">1.8</div>
                    <div class="metric-unit">NTU</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="water-trend-chart"></canvas>
            </div>
        </div>

        <div id="predictions" class="tab-content">
            <h2>AI/ML Predictions & Analytics</h2>
            
            <div class="alert alert-success">
                <strong>🤖 Model Status:</strong> All AI models are running optimally. Last training: 2 hours ago.
            </div>

            <div class="ml-insights">
                <h3>Predictive Models</h3>
                <div class="insight-item">
                    <div class="insight-icon">🔮</div>
                    <div><strong>Air Quality Forecast:</strong> LSTM model predicts AQI will drop to 65 by evening</div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon">🌊</div>
                    <div><strong>Water Quality Trend:</strong> Random Forest model shows 95% confidence in stable conditions</div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon">⚡</div>
                    <div><strong>Anomaly Detection:</strong> Autoencoder detected unusual CO pattern at 14:30</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="prediction-chart"></canvas>
            </div>
        </div>

        <div id="controls" class="tab-content">
            <h2>System Controls</h2>
            <div class="controls-section">
                <div class="controls-grid">
                    <div class="control-card">
                        <h3>Air Quality Systems</h3>
                        <div class="control-item">
                            <span>Air Purification</span>
                            <label class="switch">
                                <input type="checkbox" checked onchange="toggleControl(this, 'Air Purification')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="control-item">
                            <span>Ventilation Control</span>
                            <label class="switch">
                                <input type="checkbox" onchange="toggleControl(this, 'Ventilation Control')">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="control-card">
                        <h3>Water Treatment</h3>
                        <div class="control-item">
                            <span>Filtration System</span>
                            <label class="switch">
                                <input type="checkbox" checked onchange="toggleControl(this, 'Filtration System')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="control-item">
                            <span>pH Adjustment</span>
                            <label class="switch">
                                <input type="checkbox" onchange="toggleControl(this, 'pH Adjustment')">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <h2>Reports & Analytics</h2>
            <div class="control-card">
                <h3>Generate AI-Enhanced Reports</h3>
                <div style="margin-bottom: 15px;">
                    <label>Report Type:</label>
                    <select id="report-type" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="air">Air Quality Analysis</option>
                        <option value="water">Water Quality Analysis</option>
                        <option value="predictions">AI Predictions Report</option>
                        <option value="compliance">Compliance Report</option>
                        <option value="comprehensive">Comprehensive Analysis</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Date Range:</label>
                    <select id="date-range" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="90d">Last 90 Days</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Format:</label>
                    <select id="format" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                <button onclick="generateReport()" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    Generate AI Report
                </button>
            </div>
        </div>
    </div>

    <!-- AI Assistant -->
    <div class="ai-assistant">
        <div class="ai-chat-container" id="ai-chat">
            <div class="ai-chat-header">
                <span>EcoAI Assistant</span>
                <button onclick="toggleAIChat()" style="background: none; border: none; color: white; cursor: pointer;">×</button>
            </div>
            <div class="ai-chat-messages" id="ai-messages">
                <div class="ai-message assistant">
                    Hello! I'm your environmental monitoring AI assistant. How can I help you today?
                </div>
                <div class="ai-suggestion" onclick="sendAIMessage('What is the current air quality?')">
                    What is the current air quality?
                </div>
                <div class="ai-suggestion" onclick="sendAIMessage('Show me water quality trends')">
                    Show me water quality trends
                </div>
                <div class="ai-suggestion" onclick="sendAIMessage('Explain the PM2.5 readings')">
                    Explain the PM2.5 readings
                </div>
            </div>
            <div class="ai-chat-input">
                <input type="text" id="ai-input" placeholder="Ask about environmental data..." onkeypress="handleAIKeyPress(event)">
                <button onclick="sendAIMessage(document.getElementById('ai-input').value)">Send</button>
            </div>
        </div>
        <button class="ai-button" onclick="toggleAIChat()">🤖</button>
    </div>

    <button class="data-refresh" onclick="refreshData()" id="refresh-btn">
        🔄
    </button>

    <script>
        // Real-time data simulation and API integration
        class EnvironmentalAPI {
            constructor() {
                this.baseURL = 'https://api.environmental-data.com'; // Example API
                this.apiKey = 'your-api-key-here';
                this.sensorData = this.initializeSensorData();
                this.mlModel = null;
                this.initializeML();
            }

            initializeSensorData() {
                return {
                    airQuality: {
                        aqi: 72,
                        pm25: 35,
                        o3: 0.045,
                        no2: 0.030,
                        co: 0.5
                    },
                    waterQuality: {
                        wqi: 94,
                        ph: 7.2,
                        dissolvedOxygen: 8.5,
                        turbidity: 1.8,
                        temperature: 24.5
                    },
                    weather: {
                        temperature: 24.5,
                        humidity: 65,
                        windSpeed: 12,
                        pressure: 1013.25
                    }
                };
            }

            async initializeML() {
                try {
                    // Initialize TensorFlow.js model for predictions
                    this.mlModel = await tf.sequential({
                        layers: [
                            tf.layers.dense({ inputShape: [5], units: 32, activation: 'relu' }),
                            tf.layers.dense({ units: 16, activation: 'relu' }),
                            tf.layers.dense({ units: 1, activation: 'sigmoid' })
                        ]
                    });
                    
                    this.mlModel.compile({
                        optimizer: 'adam',
                        loss: 'meanSquaredError',
                        metrics: ['accuracy']
                    });
                    
                    console.log('ML Model initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize ML model:', error);
                }
            }

            // Simulate real-time data fetching
            async fetchRealTimeData() {
                try {
                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Simulate data fluctuation
                    this.sensorData.airQuality.aqi += (Math.random() - 0.5) * 4;
                    this.sensorData.airQuality.pm25 += (Math.random() - 0.5) * 3;
                    this.sensorData.waterQuality.ph += (Math.random() - 0.5) * 0.1;
                    this.sensorData.waterQuality.dissolvedOxygen += (Math.random() - 0.5) * 0.3;
                    
                    // Ensure values stay within realistic ranges
                    this.sensorData.airQuality.aqi = Math.max(0, Math.min(200, this.sensorData.airQuality.aqi));
                    this.sensorData.airQuality.pm25 = Math.max(0, Math.min(100, this.sensorData.airQuality.pm25));
                    this.sensorData.waterQuality.ph = Math.max(6, Math.min(8, this.sensorData.waterQuality.ph));
                    
                    return this.sensorData;
                } catch (error) {
                    console.error('Error fetching real-time data:', error);
                    return this.sensorData;
                }
            }

            // AI/ML prediction function
            async predictAirQuality(historicalData) {
                if (!this.mlModel) return null;
                
                try {
                    // Prepare input data (simplified example)
                    const inputData = tf.tensor2d([[
                        historicalData.pm25,
                        historicalData.o3,
                        historicalData.no2,
                        historicalData.co,
                        historicalData.temperature
                    ]]);
                    
                    const prediction = this.mlModel.predict(inputData);
                    const result = await prediction.data();
                    
                    inputData.dispose();
                    prediction.dispose();
                    
                    return result[0] * 100; // Convert to AQI scale
                } catch (error) {
                    console.error('Prediction error:', error);
                    return null;
                }
            }

            // Anomaly detection using statistical methods
            detectAnomalies(data, threshold = 2) {
                const anomalies = [];
                
                // Simple z-score based anomaly detection
                const values = Object.values(data);
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const std = Math.sqrt(values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length);
                
                for (const [key, value] of Object.entries(data)) {
                    const zScore = Math.abs((value - mean) / std);
                    if (zScore > threshold) {
                        anomalies.push({ parameter: key, value, zScore });
                    }
                }
                
                return anomalies;
            }
        }

        // Initialize the API system
        const envAPI = new EnvironmentalAPI();
        let charts = {};

        // Tab switching function
        function switchTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            
            const buttons = document.querySelectorAll('nav button');
            buttons.forEach(button => {
                button.classList.remove('active');
            });
            
            event.target.classList.add('active');
        }

        // Control system toggle
        function toggleControl(element, controlName) {
            const status = element.checked ? 'Active' : 'Standby';
            showMessage(`${controlName} set to ${status}`);
            
            // Simulate API call to control system
            setTimeout(() => {
                console.log(`${controlName} status changed to ${status}`);
            }, 1000);
        }

        // Report generation with AI insights
        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const dateRange = document.getElementById('date-range').value;
            const format = document.getElementById('format').value;
            
            let reportName = '';
            switch(reportType) {
                case 'air':
                    reportName = 'AI-Enhanced Air Quality Report';
                    break;
                case 'water':
                    reportName = 'Water Quality Analysis Report';
                    break;
                case 'predictions':
                    reportName = 'AI Predictions & Forecasting Report';
                    break;
                case 'compliance':
                    reportName = 'Regulatory Compliance Report';
                    break;
                case 'comprehensive':
                    reportName = 'Comprehensive Environmental Analysis';
                    break;
            }
            
            showMessage(`${reportName} generated successfully in ${format.toUpperCase()} format with AI insights`);
        }

        // Message display function
        function showMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success';
            alertDiv.innerHTML = `<strong>✅ Success:</strong> ${message}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '1000';
            alertDiv.style.maxWidth = '300px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Data refresh function
        async function refreshData() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('rotating');
            
            try {
                const data = await envAPI.fetchRealTimeData();
                updateDashboard(data);
                
                // Update timestamp
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
                // Perform anomaly detection
                const anomalies = envAPI.detectAnomalies(data.airQuality);
                if (anomalies.length > 0) {
                    console.log('Anomalies detected:', anomalies);
                    showAnomalyAlert(anomalies);
                }
                
                // Get AI predictions
                const prediction = await envAPI.predictAirQuality(data.airQuality);
                if (prediction) {
                    console.log('AI Prediction for next hour AQI:', prediction.toFixed(1));
                }
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                showMessage('Failed to refresh data. Please try again.');
            } finally {
                refreshBtn.classList.remove('rotating');
            }
        }

        // Show anomaly alert
        function showAnomalyAlert(anomalies) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning';
            alertDiv.innerHTML = `<strong>⚠️ Anomaly Detected:</strong> Unusual readings detected in ${anomalies.map(a => a.parameter).join(', ')}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '20px';
            alertDiv.style.zIndex = '1000';
            alertDiv.style.maxWidth = '400px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Update dashboard with real-time data
        function updateDashboard(data) {
            // Update metric values
            document.getElementById('aqi-value').textContent = Math.round(data.airQuality.aqi);
            document.getElementById('wqi-value').textContent = Math.round(data.waterQuality.wqi);
            document.getElementById('pm25-value').textContent = Math.round(data.airQuality.pm25);
            document.getElementById('temp-value').textContent = data.weather.temperature.toFixed(1);
            
            // Update air quality metrics
            document.getElementById('air-pm25').textContent = Math.round(data.airQuality.pm25);
            document.getElementById('air-o3').textContent = data.airQuality.o3.toFixed(3);
            document.getElementById('air-no2').textContent = data.airQuality.no2.toFixed(3);
            
            // Update water quality metrics
            document.getElementById('water-ph').textContent = data.waterQuality.ph.toFixed(1);
            document.getElementById('water-do').textContent = data.waterQuality.dissolvedOxygen.toFixed(1);
            document.getElementById('water-turbidity').textContent = data.waterQuality.turbidity.toFixed(1);
            
            // Update charts with new data
            updateCharts(data);
        }

        // Update charts with new data
        function updateCharts(data) {
            const currentTime = new Date().toLocaleTimeString();
            
            // Update real-time chart
            if (charts.realtime) {
                charts.realtime.data.labels.push(currentTime);
                charts.realtime.data.datasets[0].data.push(data.airQuality.aqi);
                charts.realtime.data.datasets[1].data.push(data.waterQuality.wqi);
                
                // Keep only last 10 data points
                if (charts.realtime.data.labels.length > 10) {
                    charts.realtime.data.labels.shift();
                    charts.realtime.data.datasets[0].data.shift();
                    charts.realtime.data.datasets[1].data.shift();
                }
                
                charts.realtime.update('none');
            }
            
            // Update air quality chart
            if (charts.airTrend) {
                charts.airTrend.data.labels.push(currentTime);
                charts.airTrend.data.datasets[0].data.push(data.airQuality.pm25);
                charts.airTrend.data.datasets[1].data.push(data.airQuality.o3 * 1000);
                charts.airTrend.data.datasets[2].data.push(data.airQuality.no2 * 1000);
                
                // Keep only last 8 data points
                if (charts.airTrend.data.labels.length > 8) {
                    charts.airTrend.data.labels.shift();
                    charts.airTrend.data.datasets.forEach(dataset => dataset.data.shift());
                }
                
                charts.airTrend.update('none');
            }
            
            // Update water quality chart
            if (charts.waterTrend) {
                charts.waterTrend.data.labels.push(currentTime);
                charts.waterTrend.data.datasets[0].data.push(data.waterQuality.ph);
                charts.waterTrend.data.datasets[1].data.push(data.waterQuality.dissolvedOxygen);
                charts.waterTrend.data.datasets[2].data.push(data.waterQuality.turbidity);
                
                // Keep only last 8 data points
                if (charts.waterTrend.data.labels.length > 8) {
                    charts.waterTrend.data.labels.shift();
                    charts.waterTrend.data.datasets.forEach(dataset => dataset.data.shift());
                }
                
                charts.waterTrend.update('none');
            }
        }

        // Initialize charts when the page loads
        window.addEventListener('load', async function() {
            // Real-time dashboard chart
            const realtimeCtx = document.getElementById('realtime-chart').getContext('2d');
            charts.realtime = new Chart(realtimeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Air Quality Index',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Water Quality Index',
                            data: [],
                            borderColor: '#34a853',
                            backgroundColor: 'rgba(52, 168, 83, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 150
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Real-Time Environmental Quality Index'
                        }
                    }
                }
            });

            // Air Quality Trend Chart
            const airTrendCtx = document.getElementById('air-trend-chart').getContext('2d');
            charts.airTrend = new Chart(airTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'PM2.5 (μg/m³)',
                            data: [],
                            borderColor: '#ea4335',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'O₃ (ppb)',
                            data: [],
                            borderColor: '#fbbc05',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'NO₂ (ppb)',
                            data: [],
                            borderColor: '#1a73e8',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Air Quality Parameters Trend'
                        }
                    }
                }
            });

            // Water Quality Trend Chart
            const waterTrendCtx = document.getElementById('water-trend-chart').getContext('2d');
            charts.waterTrend = new Chart(waterTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'pH',
                            data: [],
                            borderColor: '#34a853',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Dissolved Oxygen (mg/L)',
                            data: [],
                            borderColor: '#1a73e8',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Turbidity (NTU)',
                            data: [],
                            borderColor: '#fbbc05',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Water Quality Parameters Trend'
                        }
                    }
                }
            });

            // Prediction Chart
            const predictionCtx = document.getElementById('prediction-chart').getContext('2d');
            charts.prediction = new Chart(predictionCtx, {
                type: 'line',
                data: {
                    labels: ['Now', '+1h', '+2h', '+3h', '+4h', '+5h', '+6h'],
                    datasets: [
                        {
                            label: 'Actual AQI',
                            data: [72, null, null, null, null, null, null],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Predicted AQI',
                            data: [72, 75, 78, 82, 79, 76, 73],
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            fill: false,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Confidence Interval',
                            data: [null, 73, 76, 79, 77, 74, 71],
                            borderColor: 'rgba(118, 75, 162, 0.3)',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            fill: '+1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'AI-Powered Air Quality Predictions'
                        }
                    }
                }
            });

            // Start real-time data updates
            setInterval(refreshData, 5000); // Update every 5 seconds
            
            // Initial data load
            refreshData();
        });

        // AI Assistant Functions
        function toggleAIChat() {
            const chat = document.getElementById('ai-chat');
            chat.classList.toggle('open');
        }

        function handleAIKeyPress(event) {
            if (event.key === 'Enter') {
                sendAIMessage(document.getElementById('ai-input').value);
            }
        }

        async function sendAIMessage(message) {
            if (!message.trim()) return;
            
            const messagesContainer = document.getElementById('ai-messages');
            const input = document.getElementById('ai-input');
            
            // Add user message
            messagesContainer.innerHTML += `
                <div class="ai-message user">
                    ${message}
                </div>
            `;
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            messagesContainer.innerHTML += `
                <div class="ai-typing" id="ai-typing">
                    <div class="ai-typing-dot"></div>
                    <div class="ai-typing-dot"></div>
                    <div class="ai-typing-dot"></div>
                </div>
            `;
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Get AI response
            const response = await getAIResponse(message);
            
            // Remove typing indicator
            document.getElementById('ai-typing').remove();
            
            // Add AI response
            messagesContainer.innerHTML += `
                <div class="ai-message assistant">
                    ${marked.parse(response)}
                </div>
            `;
            
            // Scroll to bottom again
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function getAIResponse(message) {
            // Simple keyword-based responses
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('air quality') || lowerMessage.includes('aqi')) {
                const aqi = document.getElementById('aqi-value').textContent;
                const pm25 = document.getElementById('pm25-value').textContent;
                
                return `The current Air Quality Index (AQI) is **${aqi}**, which is considered **${getAQICategory(aqi)}**.  
                The PM2.5 concentration is **${pm25} μg/m³**.  
                ${getAQIAdvice(aqi)}`;
            }
            else if (lowerMessage.includes('water quality') || lowerMessage.includes('wqi')) {
                const wqi = document.getElementById('wqi-value').textContent;
                const ph = document.getElementById('water-ph').textContent;
                const doLevel = document.getElementById('water-do').textContent;
                
                return `The current Water Quality Index (WQI) is **${wqi}**, which is considered **${getWQICategory(wqi)}**.  
                - pH level: **${ph}** (ideal range: 6.5-8.5)  
                - Dissolved Oxygen: **${doLevel} mg/L** (good for aquatic life)  
                ${getWQIAdvice(wqi)}`;
            }
            else if (lowerMessage.includes('temperature')) {
                const temp = document.getElementById('temp-value').textContent;
                return `The current temperature is **${temp}°C**. This is within the normal range for this location.`;
            }
            else if (lowerMessage.includes('trend') || lowerMessage.includes('chart')) {
                return `Here are the current trends:  
                - Air Quality: ${getRandomTrend()}  
                - Water Quality: ${getRandomTrend()}  
                - Temperature: ${getRandomTrend()}  
                
                You can view detailed charts in the respective tabs.`;
            }
            else if (lowerMessage.includes('help') || lowerMessage.includes('support')) {
                return `I can help you with:  
                - Current environmental readings (air/water quality, temperature)  
                - Trends and predictions  
                - Explanation of metrics  
                - Alert notifications  
                
                Try asking about specific metrics like "What is the current AQI?" or "Explain PM2.5 levels".`;
            }
            else {
                return `I'm your environmental monitoring assistant. I can provide real-time data and insights about air quality, water quality, and other environmental metrics.  
                
                Try asking:  
                - "What is the current air quality?"  
                - "Show me water quality trends"  
                - "Explain the PM2.5 readings"`;
            }
        }

        function getAQICategory(aqi) {
            aqi = parseInt(aqi);
            if (aqi <= 50) return 'Good';
            if (aqi <= 100) return 'Moderate';
            if (aqi <= 150) return 'Unhealthy for Sensitive Groups';
            if (aqi <= 200) return 'Unhealthy';
            if (aqi <= 300) return 'Very Unhealthy';
            return 'Hazardous';
        }

        function getAQIAdvice(aqi) {
            aqi = parseInt(aqi);
            if (aqi <= 50) return 'Air quality is satisfactory, and air pollution poses little or no risk.';
            if (aqi <= 100) return 'Air quality is acceptable; however, there may be a moderate health concern for a very small number of people who are unusually sensitive to air pollution.';
            if (aqi <= 150) return 'Members of sensitive groups may experience health effects. The general public is not likely to be affected.';
            if (aqi <= 200) return 'Everyone may begin to experience health effects; members of sensitive groups may experience more serious health effects.';
            if (aqi <= 300) return 'Health alert: everyone may experience more serious health effects.';
            return 'Health warnings of emergency conditions. The entire population is more likely to be affected.';
        }

        function getWQICategory(wqi) {
            wqi = parseInt(wqi);
            if (wqi >= 90) return 'Excellent';
            if (wqi >= 70) return 'Good';
            if (wqi >= 50) return 'Fair';
            return 'Poor';
        }

        function getWQIAdvice(wqi) {
            wqi = parseInt(wqi);
            if (wqi >= 90) return 'Water quality is excellent, suitable for all uses including drinking without treatment.';
            if (wqi >= 70) return 'Water quality is good, suitable for most uses including drinking with standard treatment.';
            if (wqi >= 50) return 'Water quality is fair, may require additional treatment for drinking and may affect sensitive aquatic species.';
            return 'Water quality is poor, not suitable for drinking without extensive treatment and may harm aquatic life.';
        }

        function getRandomTrend() {
            const trends = ['stable', 'slightly increasing', 'slightly decreasing', 'showing minor fluctuations'];
            return trends[Math.floor(Math.random() * trends.length)];
        }

        // API integration with real environmental data sources
        class EPAAirQualityAPI {
            constructor() {
                this.apiKey = 'YOUR_EPA_API_KEY'; // Register at https://www.epa.gov/developers/data-data-sets
                this.baseUrl = 'https://www.airnowapi.org/aq/observation/zipCode/current';
            }

            async getCurrentAirQuality(zipCode) {
                try {
                    const response = await fetch(`${this.baseUrl}/?format=application/json&zipCode=${zipCode}&distance=25&API_KEY=${this.apiKey}`);
                    const data = await response.json();
                    
                    // Find PM2.5 reading
                    const pm25Reading = data.find(item => item.ParameterName === 'PM2.5');
                    const o3Reading = data.find(item => item.ParameterName === 'O3');
                    
                    return {
                        aqi: pm25Reading ? pm25Reading.AQI : null,
                        pm25: pm25Reading ? pm25Reading.Concentration : null,
                        o3: o3Reading ? o3Reading.Concentration : null,
                        timestamp: new Date().toISOString()
                    };
                } catch (error) {
                    console.error('EPA API error:', error);
                    return null;
                }
            }
        }

        class USGSWaterQualityAPI {
            constructor() {
                this.baseUrl = 'https://waterservices.usgs.gov/nwis/iv';
            }

            async getCurrentWaterQuality(siteId) {
                try {
                    const response = await fetch(`${this.baseUrl}/?sites=${siteId}&parameterCd=00010,00095,00300&format=json`);
                    const data = await response.json();
                    
                    const timeSeries = data.value.timeSeries;
                    const phReading = timeSeries.find(item => item.variable.variableCode[0].value === '00400');
                    const tempReading = timeSeries.find(item => item.variable.variableCode[0].value === '00010');
                    const doReading = timeSeries.find(item => item.variable.variableCode[0].value === '00300');
                    
                    return {
                        ph: phReading ? phReading.values[0].value[0].value : null,
                        temperature: tempReading ? tempReading.values[0].value[0].value : null,
                        dissolvedOxygen: doReading ? doReading.values[0].value[0].value : null,
                        timestamp: new Date().toISOString()
                    };
                } catch (error) {
                    console.error('USGS API error:', error);
                    return null;
                }
            }
        }

        // Initialize real APIs
        const epaAPI = new EPAAirQualityAPI();
        const usgsAPI = new USGSWaterQualityAPI();

        // Example usage:
        // epaAPI.getCurrentAirQuality('90210').then(data => console.log(data));
        // usgsAPI.getCurrentWaterQuality('01491000').then(data => console.log(data));

        console.log('🌍 Environmental Monitoring Dashboard with AI Assistant Ready!');
    </script>
</body>
</html>